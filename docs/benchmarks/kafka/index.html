<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Apache Kafka benchmarks</title>
  <meta name="description" content="OpenMessaging is a cloud-oriented and vendor-neutral open standard for messaging, providing industry guidelines for areas such as finance, e-commerce, IoT and Big Data and oriented toward furthering messaging and streaming applications across heterogeneous systems and platforms.
">

  <link rel="stylesheet" href="/css/foundation.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/font-awesome.css">
  <link rel="stylesheet" href="/css/syntax.css">

  <script src="/javascripts/libs.js" type="text/javascript"></script>
  <script>
    var _hmt = _hmt || []; //define it for baidu seo

    // terrificjs bootstrap
    (function($) {
        $(document).ready(function() {
            var $page = $('body');
            var config = {
              dependencyPath: {
                plugin: 'javascripts/'
              }
            }
            var application = new Tc.Application($page, config);
            application.registerModules();
            application.start();

            //Add baidu seo
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?da02b4505574c2f46febdc0874af5c8b";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        });
    })(Tc.$);
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-89603173-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-89603173-2');
  </script>

  <link href="http://fonts.googleapis.com/css?family=Raleway:400,700,300" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/masonry.pkgd.js" type="text/javascript"></script>
  <script src="/javascripts/imagesloaded.pkgd.min.js" type="text/javascript"></script>
  <script src="/javascripts/slick.min.js" type="text/javascript"></script>

  <link rel="canonical" href="/docs/benchmarks/kafka/">
  <link rel="alternate" type="application/rss+xml" title="OpenMessaging" href="/feed.xml" />
</head>


  <body>

    <a href="" id="top"></a>
<div style="width: 100%; background-color: rgb(235, 235, 235);">
    <div style="max-width: 80rem; margin: 0 auto; margin-bottom: 0; padding-left: 20px">
      <a class='' href="https://www.linuxfoundation.org/">
        <img alt="" src="/images/linux-foundation-logo.png" style="height: 18px" />
      </a>
    </div>
</div>
<div class='navbar contain-to-grid sticky'>
  <nav class='top-bar' data-options='sticky_on: large' data-topbar=''>
    <ul class='title-area'>
      <li class='name'>
        <h1>
          <a href="">
            <img alt="" src="/images/oms-logo.png" />
          </a>

        </h1>

      </li>
      <li class='toggle-topbar menu-icon'>
        <a href='#'>Menu</a>
      </li>
    </ul>
    <section class='top-bar-section'>
      <ul class="right">
        
          

          
            <li class="">
              <a href="/">Home</a>
            </li>
          
        
          

          
            <li class="has-dropdown ">
              <a href="/">Docs</a>
              <ul class='dropdown'>
                
                  <li>
                    <a href="/openmessaging-java">Java APIs</a>
                  </li>
                
                  <li>
                    <a href="/docs/benchmarks">Benchmarks</a>
                  </li>
                
              </ul>
            </li>
          
        
          

          
            <li class="">
              <a href="/blog">Blog</a>
            </li>
          
        
          

          
            <li class="">
              <a href="/community">Community</a>
            </li>
          
        
          

          
            <li class="">
              <a href="/members">Members</a>
            </li>
          
        
          

          
            <li class="has-dropdown ">
              <a href="/">About</a>
              <ul class='dropdown'>
                
                  <li>
                    <a href="/charter">Charter</a>
                  </li>
                
                  <li>
                    <a href="/contribution">Contribution</a>
                  </li>
                
              </ul>
            </li>
          
        
      </ul>
    </section>
  </nav>
</div>


    <div id='main' role='main'>
      <div class="full">
  <div class="row">
    <div class="large-9 columns">
      <div class="mod modBlogPost big no_bg">
        <h3><a href="/docs/benchmarks/kafka/">Apache Kafka benchmarks</a></h3>
        <p>This tutorial shows you how to run OpenMessaging <a href="..">benchmarks</a> for <a href="https://kafka.apache.org">Apache Kafka</a>. You can currently deploy to the following platforms:</p>

<ul>
  <li><a href="#deploy-a-kafka-cluster-on-amazon-web-services">Amazon Web Services</a> (AWS)</li>
</ul>

<h2 id="initial-setup">Initial setup</h2>

<p>To being, you’ll need to clone the <a href="https://github.com/openmessaging/openmessaging-benchmark"><code class="highlighter-rouge">benchmark</code></a> repo from the <a href="https://github.com/openmessaging"><code class="highlighter-rouge">openmessaging</code></a> organization on <a href="https://github.com">GitHub</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/openmessaging/openmessaging-benchmark
<span class="nv">$ </span><span class="nb">cd </span>openmessaging-benchmark
</code></pre></div></div>

<p>You’ll also need to have <a href="https://maven.apache.org/install.html">Maven</a> installed.</p>

<h2 id="create-local-artifacts">Create local artifacts</h2>
<blockquote>
  <p>The current Kafka client version is <code class="highlighter-rouge">2.8.1</code>. In order to downgrade it edit the <code class="highlighter-rouge">./driver-kafka/pom.xml</code> file.</p>
</blockquote>

<p>Once you have the repo cloned locally, you can create all the artifacts necessary to run the benchmarks with a single Maven command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mvn <span class="nb">install</span>
</code></pre></div></div>

<h2 id="deploy-a-kafka-cluster-on-amazon-web-services">Deploy a Kafka cluster on Amazon Web Services</h2>

<p>You can deploy a Kafka cluster on AWS (for benchmarking purposes) using <a href="https://terraform.io/">Terraform</a> and <a href="http://docs.ansible.com/ansible/latest/intro_installation.html">Ansible</a>. You’ll need to have both of those tools installed as well as the <a href="https://github.com/adammck/terraform-inventory"><code class="highlighter-rouge">terraform-inventory</code> plugin</a> for Terraform.</p>

<p>In addition, you’ll need to:</p>

<ul>
  <li><a href="https://aws.amazon.com/account/">Create an AWS account</a> (or use an existing account)</li>
  <li><a href="https://aws.amazon.com/cli/">Install the <code class="highlighter-rouge">aws</code> CLI tool</a></li>
  <li><a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html">Configure the <code class="highlighter-rouge">aws</code> CLI tool</a></li>
</ul>

<h3 id="ssh-keys">SSH keys</h3>

<p>Once you’re all set up with AWS and have the necessary tools installed locally, you’ll need to create both a public and a private SSH key at <code class="highlighter-rouge">~/.ssh/kafka_aws</code> (private) and <code class="highlighter-rouge">~/.ssh/kafka_aws.pub</code> (public), respectively.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh-keygen <span class="nt">-f</span> ~/.ssh/kafka_aws
</code></pre></div></div>

<p>When prompted to enter a passphrase, simply hit <strong>Enter</strong> twice. Then, make sure that the keys have been created:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> ~/.ssh/kafka_aws<span class="k">*</span>
</code></pre></div></div>

<h3 id="create-resources-using-terraform">Create resources using Terraform</h3>

<p>With SSH keys in place, you can create the necessary AWS resources using just a few Terraform commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>driver-kafka/deploy
<span class="nv">$ </span>terraform init
<span class="nv">$ </span>terraform apply
</code></pre></div></div>

<p>This will install the following <a href="https://aws.amazon.com/ec2">EC2</a> instances (plus some other resources, such as a <a href="https://aws.amazon.com/vpc/">Virtual Private Cloud</a> (VPC)):</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Resource</th>
      <th style="text-align: left">Description</th>
      <th style="text-align: left">Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Kafka instances</td>
      <td style="text-align: left">The VMs on which a Kafka broker will run</td>
      <td style="text-align: left">3</td>
    </tr>
    <tr>
      <td style="text-align: left">ZooKeeper instances</td>
      <td style="text-align: left">The VMs on which a ZooKeeper node will run</td>
      <td style="text-align: left">3</td>
    </tr>
    <tr>
      <td style="text-align: left">Client instance</td>
      <td style="text-align: left">The VM from which the benchmarking suite itself will be run</td>
      <td style="text-align: left">4</td>
    </tr>
  </tbody>
</table>

<p>When you run <code class="highlighter-rouge">terraform apply</code>, you will be prompted to type <code class="highlighter-rouge">yes</code>. Type <code class="highlighter-rouge">yes</code> to continue with the installation or anything else to quit.</p>

<p>Once the installation is complete, you will see a confirmation message listing the resources that have been installed.</p>

<h3 id="variables">Variables</h3>

<p>There’s a handful of configurable parameters related to the Terraform deployment that you can alter by modifying the defaults in the <code class="highlighter-rouge">terraform.tfvars</code> file.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Variable</th>
      <th style="text-align: left">Description</th>
      <th style="text-align: left">Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">region</code></td>
      <td style="text-align: left">The AWS region in which the Kafka cluster will be deployed</td>
      <td style="text-align: left"><code class="highlighter-rouge">us-west-2</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">public_key_path</code></td>
      <td style="text-align: left">The path to the SSH public key that you’ve generated</td>
      <td style="text-align: left"><code class="highlighter-rouge">~/.ssh/kafka_aws.pub</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">ami</code></td>
      <td style="text-align: left">The <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">Amazon Machine Image</a> (AWI) to be used by the cluster’s machines</td>
      <td style="text-align: left"><a href="https://access.redhat.com/articles/3135091"><code class="highlighter-rouge">ami-9fa343e7</code></a></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">instance_types</code></td>
      <td style="text-align: left">The EC2 instance types used by the various components</td>
      <td style="text-align: left"><code class="highlighter-rouge">i3.4xlarge</code> (Kafka brokers), <code class="highlighter-rouge">t2.small</code> (ZooKeeper), <code class="highlighter-rouge">c4.8xlarge</code> (benchmarking client)</td>
    </tr>
  </tbody>
</table>

<p>If you modify the <code class="highlighter-rouge">public_key_path</code>, make sure that you point to the appropriate SSH key path when running the <a href="#running-the-ansible-playbook">Ansible playbook</a>.</p>

<h3 id="running-the-ansible-playbook">Running the Ansible playbook</h3>

<p>With the appropriate infrastructure in place, you can install and start the Kafka cluster using Ansible with just one command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="se">\</span>
  <span class="nt">--user</span> ec2-user <span class="se">\</span>
  <span class="nt">--inventory</span> <span class="sb">`</span>which terraform-inventory<span class="sb">`</span> <span class="se">\</span>
  deploy.yaml
</code></pre></div></div>

<p>If you’re using an SSH private key path different from <code class="highlighter-rouge">~/.ssh/kafka_aws</code>, you can specify that path using the <code class="highlighter-rouge">--private-key</code> flag, for example <code class="highlighter-rouge">--private-key=~/.ssh/my_key</code>.</p>

<h2 id="sshing-into-the-client-host">SSHing into the client host</h2>

<p>In the <a href="https://www.terraform.io/intro/getting-started/outputs.html">output</a> produced by Terraform, there’s a <code class="highlighter-rouge">client_ssh_host</code> variable that provides the IP address for the client EC2 host from which benchmarks can be run. You can SSH into that host using this command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/kafka_aws ec2-user@<span class="k">$(</span>terraform output client_ssh_host<span class="k">)</span>
</code></pre></div></div>

<h2 id="running-the-benchmarks-from-the-client-hosts">Running the benchmarks from the client hosts</h2>

<blockquote>
  <p>The benchmark scripts can be run from the /opt/benchmark working directory.</p>
</blockquote>

<p>Once you’ve successfully SSHed into the client host, you can run any of the <a href="../#benchmarking-workloads">existing benchmarking workloads</a> by specifying the YAML file for that workload when running the <code class="highlighter-rouge">benchmark</code> executable. All workloads are in the <code class="highlighter-rouge">workloads</code> folder. Here’s an example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>bin/benchmark <span class="se">\</span>
  <span class="nt">--drivers</span> driver-kafka/kafka.yaml <span class="se">\</span>
  workloads/1-topic-16-partitions-1kb.yaml
</code></pre></div></div>

<blockquote>
  <p>Although benchmarks are run <em>from</em> a specific client host, the benchmarks are run in distributed mode, across multiple client hosts.</p>
</blockquote>

<p>There are multiple Kafka “modes” for which you can run benchmarks. Each mode has its own YAML configuration file in the <code class="highlighter-rouge">driver-kafka</code> folder.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Mode</th>
      <th style="text-align: left">Description</th>
      <th style="text-align: left">Config file</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Standard</td>
      <td style="text-align: left">Kafka with message idempotence disabled (at-least-once semantics)</td>
      <td style="text-align: left"><code class="highlighter-rouge">kafka.yaml</code></td>
    </tr>
    <tr>
      <td style="text-align: left">Exactly once</td>
      <td style="text-align: left">Kafka with message idempotence enabled (“exactly-once” semantics)</td>
      <td style="text-align: left"><code class="highlighter-rouge">kafka-exactly-once.yaml</code></td>
    </tr>
    <tr>
      <td style="text-align: left">Sync</td>
      <td style="text-align: left">Kafka with durability enabled (all published messages synced to disk)</td>
      <td style="text-align: left"><code class="highlighter-rouge">kafka-sync.yaml</code></td>
    </tr>
  </tbody>
</table>

<p>The example used the “standard” mode as configured in <code class="highlighter-rouge">driver-kafka/kafka.yaml</code>. Here are some examples for the other modes:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Exactly once</span>
<span class="nv">$ </span><span class="nb">sudo </span>bin/benchmark <span class="se">\</span>
  <span class="nt">--drivers</span> driver-kafka/kafka-exactly-once.yaml <span class="se">\</span>
  workloads/1-topic-16-partitions-1kb.yaml

<span class="c"># Sync</span>
<span class="nv">$ </span><span class="nb">sudo </span>bin/benchmark <span class="se">\</span>
  <span class="nt">--drivers</span> driver-kafka/kafka-sync.yaml <span class="se">\</span>
  workloads/1-topic-16-partitions-1kb.yaml
</code></pre></div></div>

<h3 id="specify-client-hosts">Specify client hosts</h3>

<p>By default, benchmarks will be run from the set of hosts created by Terraform. You can also specify a comma-separated list of client hosts using the <code class="highlighter-rouge">--workers</code> flag (or <code class="highlighter-rouge">-w</code> for short):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>bin/benchmark <span class="se">\</span>
  <span class="nt">--drivers</span> driver-kafka/kafka-exactly-once.yaml <span class="se">\</span>
  <span class="nt">--workers</span> 1.2.3.4:8080,4.5.6.7:8080 <span class="se">\ </span><span class="c"># or -w 1.2.3.4:8080,4.5.6.7:8080</span>
  workloads/1-topic-16-partitions-1kb.yaml
</code></pre></div></div>

<h2 id="downloading-your-benchmarking-results">Downloading your benchmarking results</h2>

<p>The OpenMessaging benchmarking suite stores results in JSON files in the <code class="highlighter-rouge">/opt/benchmark</code> folder on the client host from which the benchmarks are run. You can download those results files onto your local machine using <a href="https://linux.die.net/man/1/scp"><code class="highlighter-rouge">scp</code></a>. You can download all generated JSON results files using this command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>scp <span class="nt">-i</span> ~/.ssh/kafka_aws ec2-user@<span class="k">$(</span>terraform output client_ssh_host<span class="k">)</span>:/opt/benchmark/<span class="k">*</span>.json <span class="nb">.</span>
</code></pre></div></div>

<h2 id="tearing-down-your-benchmarking-infrastructure">Tearing down your benchmarking infrastructure</h2>

<p>Once you’re finished running your benchmarks, you should tear down the AWS infrastructure you deployed for the sake of saving costs. You can do that with one command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>terraform destroy <span class="nt">-force</span>
</code></pre></div></div>

<p>Make sure to let the process run to completion (it could take several minutes). Once the tear down is complete, all AWS resources that you created for the Kafka benchmarking suite will have been removed.</p>

      </div>
    </div>
    <div class="large-3 columns" id="sidebar">
      <div class="links">
  <h3>Documentation</h3>
  <ul>
  
  
  
  
  
  
  
  
  
  <li><h4>Benchmarks</h4></li>
  <ul>
    
    <li><a href="/docs/benchmarks">Intro</a></li>
    
    <li><a href="/docs/benchmarks/rocketmq">Apache RocketMQ</a></li>
    
    <li><a href="/docs/benchmarks/pulsar">Apache Pulsar</a></li>
    
    <li><a href="/docs/benchmarks/kafka">Apache Kafka</a></li>
    
  </ul>
  
  
  
  
  
  
  
  
  
  
  
  
  
  </ul>
</div>
    </div>
  </div>
</div>
    </div>

    <div id='footer'>
  <div class='three spacing'></div>
  <div class='row'>
    <div class='large-7 medium-3 columns'>
      <h3>
        <a href='index.html'>
          <img alt="" src="/images/oms-white-logo.png" />
        </a>
      </h3>
      <p>Copyright &copy; 2017~2022 OpenMessaging Project, a Linux Foundation Collaborative Project. All Rights Reserved unless explicitly granted under an open source license.<br> The Linux Foundation is a registered trademark of The Linux Foundation. Linux is a registered trademark of Linus Torvalds.<br> Please see our <a href="https://www.linuxfoundation.org/terms" target="_blank">terms of use</a>, <a href="https://www.linuxfoundation.org/trademark-usage" target="_blank">trademark usage</a> and <a href=" https://www.linuxfoundation.org/privacy" target="_blank">privacy policy</a></p>
      <div class='spacing'></div>
      <div class='spacing'></div>
    </div>
    <div class='large-5 medium-5 columns'>
      <div class='spacing'></div>
      <h4>Contact us</h4>
      <ul>
        <li>&nbsp;&nbsp;&nbsp;<i class="fa fa-hand-o-right" ></i>&nbsp;&nbsp;&nbsp;<a href="https://groups.google.com/forum/#!forum/openmessaging">JOIN THE MAILING LIST</a></li>
      </ul>
      <div class='spacing'></div>
      <ul class='socials'>
        <li>
          <a href='https://twitter.com/Open_Messaging'>
            <i class='fa fa-twitter'></i>
          </a>
        </li>
        <li>
          <a href='https://github.com/openmessaging'>
            <i class='fa fa-github'></i>
          </a>
        </li>
        <li>
          <a href='https://openmessaging.herokuapp.com/'>
            <i class='fa fa-slack'></i>
          </a>
        </li>
      </ul>
      <div class='spacing'></div>
    </div>
  </div>
  <div class='two spacing'></div>
</div>

<script src="/javascripts/jquery.countTo.js" type="text/javascript"></script>
<script src="/javascripts/jquery.appear.js" type="text/javascript"></script>
<script src="/javascripts/jquery.validate.js" type="text/javascript"></script>
<script src="/javascripts/jquery.sequence-min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>


  </body>

</html>
